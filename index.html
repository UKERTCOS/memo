<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Memo App</title>
    <link rel="icon" href="https://raw.githubusercontent.com/ZHOUGONG24/pic/master/cnss.svg" type="image/svg+xml">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        .container {
            width: 100%;
            max-width: 800px;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        #memo-form {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        #memo-form input, #memo-form textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            box-sizing: border-box;
        }
        #memo-form button {
            width: 100%;
            padding: 10px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        #memo-form button:hover {
            background-color: #0056b3;
        }
        #memo-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        .memo-item {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        .memo-item h3 {
            margin-top: 0;
            color: #333;
        }
        .memo-item p {
            flex-grow: 1;
            color: #666;
            margin: 0 0 10px 0;
        }
        .memo-item .category {
            font-size: 0.9em;
            color: #888;
            margin-bottom: 10px;
        }
        .memo-item .actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .memo-item button {
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .memo-item .edit-btn {
            background-color: #ffc107;
            color: white;
        }
        .memo-item .delete-btn {
            background-color: #dc3545;
            color: white;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Memo App</h1>

    <div id="toast" style="display:none;position:fixed;top:30px;left:50%;transform:translateX(-50%);background:#007bff;color:#fff;padding:10px 30px;border-radius:6px;z-index:999;font-size:18px;box-shadow:0 2px 8px rgba(0,0,0,0.15);transition:opacity 0.3s;"></div>

    <div id="loading" style="display:none;text-align:center;margin:20px 0;font-size:20px;color:#007bff;">
        <span>加载中...</span>
    </div>

    <div style="display:flex;gap:10px;margin-bottom:20px;align-items:center;">
        <input type="text" id="search-input" placeholder="搜索名称/内容..." style="flex:2;padding:8px 12px;border-radius:4px;border:1px solid #ccc;font-size:16px;">
        <select id="category-filter" style="flex:1;padding:8px 12px;border-radius:4px;border:1px solid #ccc;font-size:16px;">
            <option value="">全部分类</option>
        </select>
    </div>

    <div id="memo-form">
        <input type="hidden" id="memo-id">
        <input type="text" id="name" placeholder="Name" required>
        <input type="text" id="category" placeholder="Category" required>
        <textarea id="content" placeholder="Content" rows="4" required></textarea>
        <div style="display: flex; gap: 10px;">
            <button onclick="handleFormSubmit()" style="flex-grow: 1;">Save Memo</button>
            <button onclick="resetForm()" type="button" style="flex-grow: 1; background-color: #6c757d;">Cancel</button>
        </div>
    </div>

    <div id="memo-list">
    </div>
</div>

<script>
    const apiUrl = 'http://localhost:8000/api/memo';
    const memoList = document.getElementById('memo-list');

    const encoder = document.createElement('textarea');
    function escapeHTML(html) {
        if (html === null || typeof html === 'undefined') {
            return '';
        }
        encoder.textContent = html;
        return encoder.innerHTML;
    }

    let allMemos = [];
    async function fetchMemos() {
        document.getElementById('loading').style.display = 'block';
        try {
            const response = await fetch(apiUrl + '/');
            const data = await response.json();
            allMemos = data.memos || [];
            renderMemos();
            updateCategoryFilter();
        } catch (error) {
            console.error('Failed to fetch memos:', error);
            showToast('获取数据失败');
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    function renderMemos() {
        memoList.innerHTML = '';
        const searchValue = document.getElementById('search-input').value.trim().toLowerCase();
        const categoryValue = document.getElementById('category-filter').value;
        
        let filtered = allMemos.filter(memo => {
            const matchSearch = memo.name.toLowerCase().includes(searchValue) || memo.content.toLowerCase().includes(searchValue);
            const matchCategory = !categoryValue || memo.category === categoryValue;
            return matchSearch && matchCategory;
        });
        
        const categoryMap = {};
        filtered.forEach(memo => {
            if (!categoryMap[memo.category]) {
                categoryMap[memo.category] = [];
            }
            categoryMap[memo.category].push(memo);
        });

        const sortedCategories = Object.keys(categoryMap).sort();

        if (sortedCategories.length === 0) {
            memoList.innerHTML = '<div style="text-align:center;color:#888;font-size:18px;">没有符合条件的便签</div>';
            return;
        }

        sortedCategories.forEach(category => {
            const categorySection = document.createElement('div');
            categorySection.style.marginBottom = '30px';
            categorySection.innerHTML = `<h2 style='color:#007bff;border-bottom: 2px solid #eee; padding-bottom: 10px;'>${escapeHTML(category)}</h2>`;
            const grid = document.createElement('div');
            grid.style.display = 'grid';
            grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(250px, 1fr))';
            grid.style.gap = '20px';
            categoryMap[category].forEach(memo => {
                const memoItem = document.createElement('div');
                memoItem.className = 'memo-item';
                memoItem.innerHTML = `
                    <h3>${escapeHTML(memo.name)}</h3>
                    <p>${escapeHTML(memo.content)}</p>
                    <div class="actions">
                        <button class="edit-btn"
                                data-id="${memo.id}"
                                data-name="${escapeHTML(memo.name)}"
                                data-category="${escapeHTML(memo.category)}"
                                data-content="${escapeHTML(memo.content)}">Edit</button>
                        <button class="delete-btn" data-id="${memo.id}">Delete</button>
                    </div>
                `;
                grid.appendChild(memoItem);
            });
            categorySection.appendChild(grid);
            memoList.appendChild(categorySection);
        });
    }

    function updateCategoryFilter() {
        const select = document.getElementById('category-filter');
        const categories = Array.from(new Set(allMemos.map(m => m.category))).sort();
        select.innerHTML = '<option value="">全部分类</option>' + categories.map(c => `<option value="${escapeHTML(c)}">${escapeHTML(c)}</option>`).join('');
    }

    document.getElementById('search-input').addEventListener('input', renderMemos);
    document.getElementById('category-filter').addEventListener('change', renderMemos);

    memoList.addEventListener('click', function(event) {
        const target = event.target;
        if (target.classList.contains('edit-btn')) {
            editMemo(target);
        }
        if (target.classList.contains('delete-btn')) {
            const id = target.dataset.id;
            deleteMemo(id);
        }
    });

    async function handleFormSubmit() {
        const id = document.getElementById('memo-id').value;
        const name = document.getElementById('name').value;
        const category = document.getElementById('category').value;
        const content = document.getElementById('content').value;

        if (!name.trim() || !category.trim() || !content.trim()) {
            alert('Name, Category, and Content fields cannot be empty.');
            return;
        }

        const memo = { name, category, content };
        const isUpdate = !!id;
        const url = isUpdate ? `${apiUrl}/${id}` : `${apiUrl}/`;
        const method = isUpdate ? 'PATCH' : 'POST';

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(memo)
            });
            if (response.ok) {
                await fetchMemos();
                resetForm();
                showToast('保存成功');
            } else {
                const errText = await response.text();
                console.error(`Failed to ${isUpdate ? 'update' : 'create'} memo:`, errText);
                showToast(`保存失败: ${errText}`);
            }
        } catch (error) {
            console.error(`Error ${isUpdate ? 'updating' : 'creating'} memo:`, error);
            showToast('保存异常');
        }
    }

    function editMemo(button) {
        document.getElementById('memo-id').value = button.dataset.id;
        document.getElementById('name').value = button.dataset.name;
        document.getElementById('category').value = button.dataset.category;
        document.getElementById('content').value = button.dataset.content;
        window.scrollTo(0, 0);
    }

    async function deleteMemo(id) {
        if (confirm('Are you sure you want to delete this memo?')) {
            try {
                const response = await fetch(`${apiUrl}/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    await fetchMemos();
                    showToast('删除成功');
                } else {
                    console.error('Failed to delete memo');
                    showToast('删除失败');
                }
            } catch (error) {
                console.error('Error deleting memo:', error);
                showToast('删除异常');
            }
        }
    }

    function showToast(msg) {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.style.display = 'block';
        toast.style.opacity = '1';
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 300);
        }, 1500);
    }

    function resetForm() {
        document.getElementById('memo-id').value = '';
        document.getElementById('name').value = '';
        document.getElementById('category').value = '';
        document.getElementById('content').value = '';
    }

    window.onload = fetchMemos;
</script>

</body>
</html>